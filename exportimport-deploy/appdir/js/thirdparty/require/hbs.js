/**
 * @license Handlebars hbs 0.4.0 - Alex Sexton, but Handlebars has it's own licensing junk
 *
 * Available via the MIT or new BSD license.
 * see: http://github.com/jrburke/require-cs for details on the plugin this was based off of
 * https://github.com/SlexAxton/require-handlebars-plugin
 */

define(["Handlebars","underscore","i18nprecompile","json2"],function(Handlebars,_,precompile,JSON){var fs,getXhr,progIds=["Msxml2.XMLHTTP","Microsoft.XMLHTTP","Msxml2.XMLHTTP.4.0"],fetchText=function(){throw new Error("Environment unsupported.")},buildMap=[],filecode="w+",templateExtension="hbs",customNameExtension="@hbs",devStyleDirectory="/styles/",buildStyleDirectory="/demo-build/styles/",helperDirectory="template/helpers/",i18nDirectory="template/i18n/",buildCSSFileName="screen.build.css";Handlebars.registerHelper("$",function(){}),typeof window!="undefined"&&window.navigator&&window.document&&!window.navigator.userAgent.match(/Node.js/)?(getXhr=function(){var xhr,i,progId;if(typeof XMLHttpRequest!="undefined")return new XMLHttpRequest;for(i=0;i<3;i++){progId=progIds[i];try{xhr=new ActiveXObject(progId)}catch(e){}if(xhr){progIds=[progId];break}}if(!xhr)throw new Error("getXhr(): XMLHttpRequest not available");return xhr},fetchText=function(url,callback){var xhr=getXhr();xhr.open("GET",url,!0),xhr.onreadystatechange=function(evt){xhr.readyState===4&&callback(xhr.responseText)},xhr.send(null)}):typeof process!="undefined"&&process.versions&&!!process.versions.node?(fs=require.nodeRequire("fs"),fetchText=function(path,callback){var body=fs.readFileSync(path,"utf8")||"";body=body.replace(/^\uFEFF/,""),callback(body)}):typeof java!="undefined"&&typeof java.io!="undefined"&&(fetchText=function(path,callback){var f=new java.io.File(path),is=new java.io.FileReader(f),reader=new java.io.BufferedReader(is),line,text="";while((line=reader.readLine())!==null)text+=new String(line)+"\n";reader.close(),callback(text)});var cache={},fetchOrGetCached=function(path,callback){cache[path]?callback(cache[path]):fetchText(path,function(data){cache[path]=data,callback.call(this,data)})},styleList=[],styleMap={};return{get:function(){return Handlebars},write:function(pluginName,name,write){if(name+customNameExtension in buildMap){var text=buildMap[name+customNameExtension];write.asModule(pluginName+"!"+name,text)}},version:"0.4.0",load:function(name,parentRequire,load,config){var compiledName=name+customNameExtension,disableI18n=config.hbs&&config.hbs.disableI18n,partialDeps=[];function recursiveNodeSearch(statements,res){return _(statements).forEach(function(statement){statement&&statement.type&&statement.type==="partial"&&res.push(statement.partialName.name),statement&&statement.program&&statement.program.statements&&recursiveNodeSearch(statement.program.statements,res),statement&&statement.program&&statement.program.inverse&&statement.program.inverse.statements&&recursiveNodeSearch(statement.program.inverse.statements,res)}),res}function findPartialDeps(nodes){var res=[];return nodes&&nodes.statements&&(res=recursiveNodeSearch(nodes.statements,[])),_(res).unique()}function getMetaData(nodes){var statement,res,test;if(nodes&&nodes.statements){statement=nodes.statements[0];if(statement&&statement.type==="comment")try{return res=statement.comment.replace(new RegExp("^[\\s]+|[\\s]+$","g"),""),test=JSON.parse(res),res}catch(e){return"{}"}}return"{}"}function composeParts(parts){if(!parts)return[];var res=[parts[0]],cur=parts[0],i;for(i=1;i<parts.length;++i)parts.hasOwnProperty(i)&&(cur+="."+parts[i],res.push(cur));return res}function recursiveVarSearch(statements,res,prefix,helpersres){prefix=prefix?prefix+".":"";var newprefix="",flag=!1;return _(statements).forEach(function(statement){var parts,part,sideways;if(statement&&statement.type&&statement.type==="mustache"){if(!statement.params||!statement.params.length){parts=composeParts(statement.id.parts);for(part in parts)parts[part]&&(newprefix=parts[part]||newprefix,res.push(prefix+parts[part]));res.push(prefix+statement.id.string)}var paramsWithoutParts=["this",".","..","./..","../..","../../.."];statement.params&&typeof Handlebars.helpers[statement.id.string]=="undefined"&&_(statement.params).forEach(function(param){(_(paramsWithoutParts).contains(param.original)||param instanceof Handlebars.AST.StringNode||param instanceof Handlebars.AST.IntegerNode||param instanceof Handlebars.AST.BooleanNode)&&helpersres.push(statement.id.string),parts=composeParts(param.parts);for(var part in parts)parts[part]&&(newprefix=parts[part]||newprefix,helpersres.push(statement.id.string),res.push(prefix+parts[part]))})}statement&&statement.mustache&&recursiveVarSearch([statement.mustache],res,prefix+newprefix,helpersres),statement&&statement.program&&statement.program.statements&&(sideways=recursiveVarSearch([statement.mustache],[],"",helpersres)[0]||"",statement.program.inverse&&statement.program.inverse.statements&&recursiveVarSearch(statement.program.inverse.statements,res,prefix+newprefix+(sideways?prefix+newprefix?"."+sideways:sideways:""),helpersres),recursiveVarSearch(statement.program.statements,res,prefix+newprefix+(sideways?prefix+newprefix?"."+sideways:sideways:""),helpersres))}),res}function getExternalDeps(nodes){var res=[],helpersres=[];nodes&&nodes.statements&&(res=recursiveVarSearch(nodes.statements,[],undefined,helpersres));var defaultHelpers=["helperMissing","blockHelperMissing","each","if","unless","with"];return{vars:_(res).chain().unique().map(function(e){return e===""?".":e.length&&e[e.length-1]==="."?e.substr(0,e.length-1)+"[]":e}).value(),helpers:_(helpersres).chain().unique().map(function(e){return _(defaultHelpers).contains(e)?undefined:e}).compact().value()}}function fetchAndRegister(langMap){fetchText(path,function(text){var nodes=Handlebars.parse(text),deps=findPartialDeps(nodes),meta=getMetaData(nodes),extDeps=getExternalDeps(nodes),vars=extDeps.vars,helps=extDeps.helpers||[],depStr=deps.join("', 'hbs!").replace(/_/g,"/"),helpDepStr=config.hbs&&config.hbs.disableHelpers?"":function(){var i,paths=[],pathGetter=config.hbs&&config.hbs.helperPathCallback?config.hbs.helperPathCallback:function(name){return(config.hbs&&config.hbs.helperDirectory?config.hbs.helperDirectory:helperDirectory)+name};for(i=0;i<helps.length;i++)paths[i]="'"+pathGetter(helps[i],path)+"'";return paths}().join(","),debugOutputStart="",debugOutputEnd="",debugProperties="",metaObj,head,linkElem;depStr&&(depStr=",'hbs!"+depStr+"'"),helpDepStr&&(helpDepStr=","+helpDepStr);if(meta!=="{}")try{metaObj=JSON.parse(meta),metaObj&&metaObj.styles&&(styleList=_.union(styleList,metaObj.styles),require.isBrowser&&!config.isBuild?(head=document.head||document.getElementsByTagName("head")[0],_(metaObj.styles).forEach(function(style){styleMap[style]||(linkElem=document.createElement("link"),linkElem.href=config.baseUrl+devStyleDirectory+style+".css",linkElem.media="all",linkElem.rel="stylesheet",linkElem.type="text/css",head.appendChild(linkElem),styleMap[style]=linkElem)})):config.isBuild&&function(){var fs=require.nodeRequire("fs"),str=_(metaObj.styles).map(function(style){return styleMap[style]?"":(styleMap[style]=!0,"@import url("+style+".css);\n")}).join("\n");fs.open(__dirname+buildStyleDirectory+buildCSSFileName,filecode,"0666",function(e,id){fs.writeSync(id,str,null,encoding="utf8"),fs.close(id)}),filecode="a"}())}catch(e){console.log("error injecting styles")}!config.isBuild&&!config.serverRender&&(debugOutputStart="<!-- START - "+name+" -->",debugOutputEnd="<!-- END - "+name+" -->",debugProperties="t.meta = "+meta+";\n"+"t.helpers = "+JSON.stringify(helps)+";\n"+"t.deps = "+JSON.stringify(deps)+";\n"+"t.vars = "+JSON.stringify(vars)+";\n");var mapping=disableI18n?!1:_.extend(langMap,config.localeMapping),configHbs=config.hbs||{},options=_.extend(configHbs.compileOptions||{},{originalKeyFallback:configHbs.originalKeyFallback}),prec=precompile(text,mapping,options);text="/* START_TEMPLATE */\ndefine(['hbs','Handlebars'"+depStr+helpDepStr+"], function( hbs, Handlebars ){ \n"+"var t = Handlebars.template("+prec+");\n"+"Handlebars.registerPartial('"+name.replace(/\//g,"_")+"', t);\n"+debugProperties+"return t;\n"+"});\n"+"/* END_TEMPLATE */\n",config.isBuild&&(buildMap[compiledName]=text),config.isBuild||(text+="\r\n//@ sourceURL="+path);for(var i in deps)deps.hasOwnProperty(i)&&(deps[i]="hbs!"+deps[i].replace(/_/g,"/"));config.isBuild?(load.fromText(name,text),parentRequire([name],function(value){load(value)})):require(deps,function(){load.fromText(text),parentRequire([name],function(value){load(value)})}),config.removeCombined&&fs.unlinkSync(path)})}var path,omitExtension=config.hbs&&config.hbs.templateExtension===!1;omitExtension?path=parentRequire.toUrl(name):path=parentRequire.toUrl(name+"."+(config.hbs&&config.hbs.templateExtension?config.hbs.templateExtension:templateExtension));if(disableI18n)fetchAndRegister(!1);else{var langMapPath=(config.hbs&&config.hbs.i18nDirectory?config.hbs.i18nDirectory:i18nDirectory)+(config.locale||"en_us")+".json";try{fetchOrGetCached(parentRequire.toUrl(langMapPath),function(langMap){fetchAndRegister(JSON.parse(langMap))})}catch(er){if(!!config.hbs)throw er;console.warn("hbs: Error reading "+langMapPath+", disabling i18n. Ignore this if you're using jam, otherwise check your i18n configuration.\n"),config.hbs={disableI18n:!0},fetchAndRegister(!1)}}}}});