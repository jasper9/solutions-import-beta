define(["Handlebars","underscore"],function(Handlebars,_){function replaceLocaleStrings(ast,mapping,options){return options=options||{},mapping=mapping||{},ast&&ast.type==="program"&&ast.statements&&(_(ast.statements).forEach(function(statement,i){var newString="<!-- i18n error -->";if(statement.type=="mustache"&&statement.id&&statement.id.original=="$"){if(statement.params.length&&statement.params[0].string){var key=statement.params[0].string;newString=mapping[key]||(options.originalKeyFallback?key:newString)}ast.statements[i]=new Handlebars.AST.ContentNode(newString)}else statement.program&&(statement.program=replaceLocaleStrings(statement.program,mapping,options))}),ast.inverse&&replaceLocaleStrings(ast.inverse,mapping,options)),ast}return function(string,mapping,options){options=options||{};var ast,environment;return ast=Handlebars.parse(string),mapping!==!1&&(ast=replaceLocaleStrings(ast,mapping,options)),environment=(new Handlebars.Compiler).compile(ast,options),(new Handlebars.JavaScriptCompiler).compile(environment,options)}});